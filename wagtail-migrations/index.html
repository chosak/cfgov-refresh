<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Wagtail and Django migrations - cfgov-refresh</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  <link href="../css/overrides.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Wagtail and Django migrations";
    var mkdocs_page_input_path = "wagtail-migrations.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> cfgov-refresh</a>
        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Introduction</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../installation/">Installation</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../usage/">Usage</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Building and Deploying for cf.gov</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../new-projects/">New projects</a>
                </li>
                <li class="">
                    
    <a class="" href="../branching-merging/">Branching and merging</a>
                </li>
                <li class="">
                    
    <a class="" href="../feature-flags/">Feature flags</a>
                </li>
                <li class="">
                    
    <a class="" href="../split-testing/">Split testing</a>
                </li>
                <li class="">
                    
    <a class="" href="../wagtail-components/">Wagtail components</a>
                </li>
                <li class="">
                    
    <a class="" href="../travis/">How we use Travis CI</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Back-end guidelines</span>
    <ul class="subnav">
                <li class=" current">
                    
    <a class="current" href="./">Wagtail and Django migrations</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#wagtail-and-django-data-migrations">Wagtail and Django data migrations</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#migrating-streamfields">Migrating StreamFields</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../django-to-wagtail/">Wagtail Pages vs Django views</a>
                </li>
                <li class="">
                    
    <a class="" href="../forms-in-wagtail/">Forms in Wagtail page context</a>
                </li>
                <li class="">
                    
    <a class="" href="../testing-be/">Testing</a>
                </li>
                <li class="">
                    
    <a class="" href="../translation/">Translation</a>
                </li>
                <li class="">
                    
    <a class="" href="../caching/">Caching</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Front-end guidelines</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../atomic-structure/">Atomic structure and design</a>
                </li>
                <li class="">
                    
    <a class="" href="../testing-fe/">Testing</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../development-tips/">Development tips</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">APIs</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../ask-cfpb/">Ask CFPB</a>
                </li>
                <li class="">
                    
    <a class="" href="../consumer-complaint-database/">Consumer complaints</a>
                </li>
                <li class="">
                    
    <a class="" href="../hmda/">HMDA data</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">cfgov-refresh</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Back-end guidelines &raquo;</li>
        
      
    
    <li>Wagtail and Django migrations</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/cfpb/cfgov-refresh/edit/master/docs/wagtail-migrations.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="wagtail-and-django-data-migrations">Wagtail and Django data migrations<a class="headerlink" href="#wagtail-and-django-data-migrations" title="Permanent link">¶</a></h1>
<p>Django data migrations with Wagtail can be challenging because programmatic editing of Wagtail pages <a href="https://github.com/torchbox/wagtail/issues/1101">is difficult</a>, and pages have both revisions and StreamFields. This document is intended to describe ways we try to address these challenges in cfgov-refresh.</p>
<h2 id="migrating-streamfields">Migrating StreamFields<a class="headerlink" href="#migrating-streamfields" title="Permanent link">¶</a></h2>
<p>StreamFields do not follow a fixed structure, rather they're a freeform sequences of blocks. Making a change to a StreamField involves both creating a <a href="https://docs.djangoproject.com/en/1.11/topics/migrations/#workflow">Django schema migration</a> and a custom <a href="https://docs.djangoproject.com/en/1.11/topics/migrations/#data-migrations">Django data migration</a>. The data migration needs to modify both the existing Wagtail pages that correspond to the changed model and all revisions of that page. It also needs to be able to manipulate the StreamField contents.</p>
<p>To this end, there are some utility functions in cfgov-refresh that make this easier. Using these utilities, a Django data migration that modifies a StreamField would use the following format:</p>
<pre class="highlight"><code class="language-python">from django.db import migrations

from v1.util.migrations import migrate_page_types_and_fields


def forward_mapper(page_or_revision, data):
    data = dict(data)
    # Manipulate the stream block data forwards
    return data


def backward_mapper(page_or_revision, data):
    data = dict(data)
    # Manipulate the stream block data backwards
    return data


def forwards(apps, schema_editor):
    page_types_and_fields = [
        ('myapp', 'MyPage', 'streamfield_name', 'streamblock_type'),
    ]
    migrate_page_types_and_fields(apps,
                                  page_types_and_fields,
                                  forward_mapper)


def backwards(apps, schema_editor):
    page_types_and_fields = [
        ('myapp', 'MyPage', 'streamfield_name', 'streamblock_type'),
    ]
    migrate_page_types_and_fields(apps,
                                  page_types_and_fields,
                                  backward_mapper)


class Migration(migrations.Migration):
    dependencies = []
    operations = [
        migrations.RunPython(forwards, backwards),
    ]</code></pre>

<h3 id="utility-functions">Utility functions<a class="headerlink" href="#utility-functions" title="Permanent link">¶</a></h3>
<p>These functions are available in <code>v1.util.migrations</code>.</p>
<h5 id="migrate_page_types_and_fieldsapps-page_types_and_fields-mapper"><code>migrate_page_types_and_fields(apps, page_types_and_fields, mapper)</code><a class="headerlink" href="#migrate_page_types_and_fieldsapps-page_types_and_fields-mapper" title="Permanent link">¶</a></h5>
<p>Migrate the fields of a wagtail page type using the given mapper function. page_types_and_fields should be a list of 4-tuples providing ('app', 'PageType', 'field_name', 'block type').</p>
<p>The mapper function should take <code>page_or_revision</code> and the stream block value.</p>
<h5 id="migrate_stream_fieldpage_or_revision-field_name-block_type-mapper"><code>migrate_stream_field(page_or_revision, field_name, block_type, mapper)</code><a class="headerlink" href="#migrate_stream_fieldpage_or_revision-field_name-block_type-mapper" title="Permanent link">¶</a></h5>
<p>Migrate a block of the type within a StreamField of the name belonging to the page or revision using the mapper function.</p>
<p>The mapper function should take <code>page_or_revision</code> and the stream block value.</p>
<h5 id="get_stream_datapage_or_revision-field_name"><code>get_stream_data(page_or_revision, field_name)</code><a class="headerlink" href="#get_stream_datapage_or_revision-field_name" title="Permanent link">¶</a></h5>
<p>Get the stream field data for a given field name on a page or a revision.</p>
<p>This function will return a list of <code>dict</code>-like objects containing the blocks within the given StreamField.</p>
<h5 id="set_stream_datapage_or_revision-field_name-stream_data-committrue"><code>set_stream_data(page_or_revision, field_name, stream_data, commit=True)</code><a class="headerlink" href="#set_stream_datapage_or_revision-field_name-stream_data-committrue" title="Permanent link">¶</a></h5>
<p>Set the stream field data for a given field name on a page or a revision. If commit is True (default) <code>save()</code> is called on the <code>page_or_revision</code> object.</p>
<p><code>stream_data</code> must be a list of <code>dict</code>-like objects containing the blocks within the given StreamField.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../django-to-wagtail/" class="btn btn-neutral float-right" title="Wagtail Pages vs Django views">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../travis/" class="btn btn-neutral" title="How we use Travis CI"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/cfpb/cfgov-refresh/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../travis/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../django-to-wagtail/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>

</body>
</html>
